---
interface ContributionDay {
  contributionCount: number;
  date: string;
  color: string;
}

interface ContributionWeek {
  contributionDays: ContributionDay[];
}

interface ContributionCalendar {
  totalContributions: number;
  weeks: ContributionWeek[];
}

interface ContributionsCollection {
  contributionCalendar: ContributionCalendar;
}

interface User {
  contributionsCollection: ContributionsCollection;
}

interface GitHubAPIResponse {
  data: {
    user: User;
  };
  errors?: Array<{ message: string }>;
}

const GH_TOKEN = import.meta.env.GH_TOKEN as string;
const GH_USERNAME = import.meta.env.GH_USERNAME as string;

let contributionData: GitHubAPIResponse | null = null;
let totalContributions = 0;
let currentYear = new Date().getFullYear();

if (GH_TOKEN && GH_USERNAME) {
  const startOfYear = new Date(currentYear, 0, 1);
  const today = new Date();
  
  const from: string = startOfYear.toISOString();
  const to: string = today.toISOString();

  const query = `
    query($username: String!, $from: DateTime!, $to: DateTime!) {
      user(login: $username) {
        contributionsCollection(from: $from, to: $to) {
          contributionCalendar {
            totalContributions
            weeks {
              contributionDays {
                contributionCount
                date
                color
              }
            }
          }
        }
      }
    }
  `;

  try {
    const response = await fetch('https://api.github.com/graphql', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${GH_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        query,
        variables: { username: GH_USERNAME, from, to }
      })
    });

    const data: GitHubAPIResponse = await response.json();
    
    if (data.errors) {
      console.error('GitHub API errors:', data.errors);
    } else if (data.data?.user?.contributionsCollection?.contributionCalendar) {
      contributionData = data;
      totalContributions = data.data.user.contributionsCollection.contributionCalendar.totalContributions;
    } else {
      console.error('Unexpected API response structure:', JSON.stringify(data));
    }
  } catch (error) {
    console.error('Failed to fetch contributions:', error);
  }
} else {
  console.warn('GitHub token or username not configured. Set GH_TOKEN and GH_USERNAME environment variables.');
}

const weeks: ContributionWeek[] = contributionData?.data?.user?.contributionsCollection?.contributionCalendar?.weeks || [];
---

<div class="contributions-container">
  <div class="header">
    <h3>GitHub Contributions ({currentYear})</h3>
    {totalContributions > 0 && (
      <span class="total">{totalContributions} contributions this year</span>
    )}
  </div>
  {weeks.length > 0 ? (
    <div class="graph">
      {weeks.map((week: ContributionWeek) => (
        <div class="week">
          {week.contributionDays.map((day: ContributionDay) => (
            <div 
              class="day" 
              style={`background-color: ${day.color || '#161b22'};`}
              title={`${day.date}: ${day.contributionCount} contributions`}
            ></div>
          ))}
        </div>
      ))}
    </div>
  ) : (
    <p style="color: red;">Failed to load contributions. Check console for details.</p>
  )}
</div>

<style>
  .contributions-container {
    margin-top: 20px;
    width: 100%;
    padding: 0 1rem;
  }

  @media (min-width: 640px) {
    .contributions-container {
      margin-top: 20px;
    }
  }

  @media (min-width: 1024px) {
    .contributions-container {
      margin-top: 20px;
      padding: 0;
    }
  }
  
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .contributions-container h3 {
    font-size: 1rem;
    font-weight: 500;
    margin: 0;
  }

  @media (min-width: 640px) {
    .contributions-container h3 {
      font-size: 1.125rem;
    }
  }

  @media (min-width: 1024px) {
    .contributions-container h3 {
      font-size: 1.25rem;
    }
  }
  
  .total {
    color: #8b949e;
    font-size: 0.75rem;
  }

  @media (min-width: 640px) {
    .total {
      font-size: 0.875rem;
    }
  }

  @media (min-width: 1024px) {
    .total {
      font-size: 0.9rem;
    }
  }
  
  .graph {
    display: flex;
    gap: 2px;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 0.75rem;
    background: #0d1117;
    border-radius: 8px;
    width: 100%;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: #30363d #0d1117;
  }

  @media (min-width: 640px) {
    .graph {
      gap: 3px;
      padding: 1rem;
    }
  }
  
  .graph::-webkit-scrollbar {
    height: 8px;
  }
  
  .graph::-webkit-scrollbar-track {
    background: #0d1117;
    border-radius: 4px;
  }
  
  .graph::-webkit-scrollbar-thumb {
    background: #30363d;
    border-radius: 4px;
  }
  
  .graph::-webkit-scrollbar-thumb:hover {
    background: #484f58;
  }
  
  .week {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex-shrink: 0;
  }

  @media (min-width: 640px) {
    .week {
      gap: 3px;
    }
  }
  
  .day {
    width: 10px;
    height: 10px;
    min-width: 10px;
    min-height: 10px;
    border-radius: 2px;
    flex-shrink: 0;
    display: block;
    transition: transform 0.2s ease;
  }

  @media (min-width: 640px) {
    .day {
      width: 11px;
      height: 11px;
      min-width: 11px;
      min-height: 11px;
    }
  }

  @media (min-width: 1024px) {
    .day {
      width: 12px;
      height: 12px;
      min-width: 12px;
      min-height: 12px;
    }
  }
  
  .day:hover {
    transform: scale(1.5);
    z-index: 10;
    position: relative;
  }
  
  @media (max-width: 1024px) {
    .day {
      width: 10px;
      height: 10px;
      min-width: 10px;
      min-height: 10px;
    }
    
    .graph {
      gap: 2px;
    }
    
    .week {
      gap: 2px;
    }
  }
  
  @media (max-width: 768px) {
    .day {
      width: 8px;
      height: 8px;
      min-width: 8px;
      min-height: 8px;
    }
    
    .graph {
      gap: 2px;
      padding: 0.75rem;
    }
    
    .week {
      gap: 2px;
    }
    
    .contributions-container h3 {
      font-size: 1.1rem;
    }
    
    .total {
      font-size: 0.85rem;
    }
  }
  
  @media (max-width: 480px) {
    .day {
      width: 6px;
      height: 6px;
      min-width: 6px;
      min-height: 6px;
      border-radius: 1px;
    }
    
    .graph {
      gap: 1.5px;
      padding: 0.5rem;
    }
    
    .week {
      gap: 1.5px;
    }
    
    .contributions-container {
      margin-top: 20px;
    }
  }
</style>
